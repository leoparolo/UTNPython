{% extends "base.html" %}
{% block content %}
<h2 class="mb-4 text-center">Listado de Préstamos</h2>

<div class="mb-3 text-end">
    <a href="/prestamos/create" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Nuevo Préstamo
    </a>
</div>

<table id="tabla-prestamos" class="table table-striped table-hover table-bordered">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Libro</th>
            <th>Inicio</th>
            <th>Esperada</th>
            <th>Fin</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for prestamo in prestamos %}
        <tr>
            <td>{{ prestamo.prestamo_id }}</td>
            <td>{{ prestamo.usuario.nombre }} {{ prestamo.usuario.apellido }}</td>
            <td>{{ prestamo.libro.titulo }}</td>
            <td>{{ prestamo.fecha_prestamo.strftime('%Y-%m-%d %H:%M') if prestamo.fecha_prestamo else '—' }}</td>
            <td>{{ prestamo.fecha_devolucion_esperada.strftime('%Y-%m-%d %H:%M') if prestamo.fecha_devolucion_esperada else '—' }}</td>
            <td>{{ prestamo.fecha_devolucion_real.strftime('%Y-%m-%d %H:%M') if prestamo.fecha_devolucion_real else '—' }}</td>
            <td data-order="{% if prestamo.estado == 'D' %}4{% elif prestamo.estado == 'A' %}2{% elif prestamo.estado == 'E' %}1{% elif prestamo.estado == 'P' %}3{% else %}5{% endif %}">
              {% if prestamo.estado == 'D' %}
                <span class="badge bg-success">{{ prestamo.estado }}</span>
              {% elif prestamo.estado == 'A' %}
                <span class="badge bg-danger">{{ prestamo.estado }}</span>
              {% elif prestamo.estado == 'E' %}
                <span class="badge bg-warning text-dark">{{ prestamo.estado }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ prestamo.estado }}</span>
              {% endif %}
            </td>

            <td>
                {% if not prestamo.fecha_devolucion_real %}
                <form method="post" action="/api/prestamos/{{ prestamo.prestamo_id }}/finalizar" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-success" 
                      onclick="return confirm('¿Finalizar préstamo y registrar devolución?');">
                        <i class="bi bi-check-lg"></i> Finalizar
                    </button>
                </form>
                {% else %}
                <span class="text-success">Finalizado</span>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="mt-3">
    <strong>Leyenda de estados:</strong>
    <ul class="list-inline">
        <li class="list-inline-item"><span class="badge bg-success">D</span> = Devuelto</li>
        <li class="list-inline-item"><span class="badge bg-danger">A</span> = Atrasado</li>
        <li class="list-inline-item"><span class="badge bg-warning text-dark">E</span> = En curso</li>
        <li class="list-inline-item"><span class="badge bg-secondary">P</span> = Pendiente</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {
    $('#tabla-prestamos').DataTable({
        "order": [[6, "asc"]],
        "language": {
            "search": "Filtrar:",
            "lengthMenu": "Mostrar _MENU_ préstamos por página",
            "zeroRecords": "No se encontraron préstamos",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ préstamos",
            "infoEmpty": "No hay préstamos disponibles",
            "infoFiltered": "(filtrado de _MAX_ préstamos en total)"
        }
    });
  });
</script>
{% endblock %}
